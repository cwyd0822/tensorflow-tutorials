<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>详解TensorFlow之tf.train.sliceinputproducer和tf.train.stringinputproducer生成器 | TensorFlow从入门到精通</title>
    <meta name="description" content="TensorFlow知识点串讲和项目实战">
    
    
    <link rel="preload" href="/assets/css/0.styles.17f32d1e.css" as="style"><link rel="preload" href="/assets/js/app.7619c6b3.js" as="script"><link rel="preload" href="/assets/js/2.e197e3e4.js" as="script"><link rel="preload" href="/assets/js/8.88e1533d.js" as="script"><link rel="prefetch" href="/assets/js/10.e19b3701.js"><link rel="prefetch" href="/assets/js/11.bcb96f38.js"><link rel="prefetch" href="/assets/js/3.5ecd6063.js"><link rel="prefetch" href="/assets/js/4.3ff2fe10.js"><link rel="prefetch" href="/assets/js/5.9c8e0335.js"><link rel="prefetch" href="/assets/js/6.612b0a42.js"><link rel="prefetch" href="/assets/js/7.101924b7.js"><link rel="prefetch" href="/assets/js/9.d0d641fa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.17f32d1e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">TensorFlow从入门到精通</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/guide/" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/cwyd0822/tensorflow-tutorials" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://blog.csdn.net/keyandi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/guide/" class="nav-link">目录</a></div><div class="nav-item"><a href="https://github.com/cwyd0822/tensorflow-tutorials" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://blog.csdn.net/keyandi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/guide/" class="sidebar-link">目录</a></li><li><a href="/article/batch-norm.html" class="sidebar-link">batch-norm函数</a></li><li><a href="/article/input-producer.html" class="active sidebar-link">input-producer函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/input-producer.html#tf-train-slice-input-producer是什么" class="sidebar-link">tf.train.sliceinputproducer是什么</a></li><li class="sidebar-sub-header"><a href="/article/input-producer.html#tf-train-slice-input-producer函数" class="sidebar-link">tf.train.sliceinputproducer函数</a></li><li class="sidebar-sub-header"><a href="/article/input-producer.html#tf-train-start-queue-runners-函数" class="sidebar-link">tf.train.startqueuerunners()函数</a></li><li class="sidebar-sub-header"><a href="/article/input-producer.html#代码演示：reader-cifar10-1-py" class="sidebar-link">代码演示：reader_cifar10-1.py</a></li><li class="sidebar-sub-header"><a href="/article/input-producer.html#tf-train-string-input-producer-函数" class="sidebar-link">tf.train.stringinputproducer()函数</a></li></ul></li><li><a href="/article/batch-and-shuffle-batch.html" class="sidebar-link">batch函数</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="详解tensorflow之tf-train-slice-input-producer和tf-train-string-input-producer生成器"><a href="#详解tensorflow之tf-train-slice-input-producer和tf-train-string-input-producer生成器" class="header-anchor">#</a> 详解TensorFlow之tf.train.slice_input_producer和tf.train.string_input_producer生成器</h1> <h2 id="tf-train-slice-input-producer是什么"><a href="#tf-train-slice-input-producer是什么" class="header-anchor">#</a> tf.train.slice_input_producer是什么</h2> <p>tf.train.slice_input_producer是一个tensor生成器，作用是按照设定，每次从一个tensor列表中按顺序或者随机抽取出一个tensor放入队列。</p> <h2 id="tf-train-slice-input-producer函数"><a href="#tf-train-slice-input-producer函数" class="header-anchor">#</a> tf.train.slice_input_producer函数</h2> <div class="language-python extra-class"><pre class="language-python"><code>slice_input_producer<span class="token punctuation">(</span>tensor_list<span class="token punctuation">,</span> num_epochs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> capacity<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shared_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>tensor_list：包含一系列tensor的列表，表中tensor的第一维度的值必须相等，即个数必须相等，有多少个图像，就应该有多少个对应的标签。</li> <li>第二个参数num_epochs: 可选参数，是一个整数值，代表迭代的次数，如果设置 num_epochs=None,生成器可以无限次遍历tensor列表，如果设置为 num_epochs=N，生成器只能遍历tensor列表N次。</li> <li>第三个参数shuffle：bool类型，设置是否打乱样本的顺序。一般情况下，如果shuffle=True，生成的样本顺序就被打乱了，在批处理的时候不需要再次打乱样本，使用 tf.train.batch函数就可以了;如果shuffle=False,就需要在批处理时候使用 tf.train.shuffle_batch函数打乱样本。</li> <li>第四个参数seed: 可选的整数，是生成随机数的种子，在第三个参数设置为shuffle=True的情况下才有用。</li> <li>第五个参数capacity：设置tensor列表的容量。</li> <li>第六个参数shared_name：可选参数，如果设置一个‘shared_name’，则在不同的上下文环境（Session）中可以通过这个名字共享生成的tensor。</li> <li>第七个参数name：可选，设置操作的名称。</li></ul> <h2 id="tf-train-start-queue-runners-函数"><a href="#tf-train-start-queue-runners-函数" class="header-anchor">#</a> tf.train.start_queue_runners()函数</h2> <ul><li>TensorFlow的Session对象是支持多线程的，可以在同一个会话（Session）中创建多个线程，并行执行。在Session中的所有线程都必须能被同步终止，异常必须能被正确捕获并报告，会话终止的时候，队列必须能被正确地关闭。</li> <li>TensorFlow提供了两个类来实现对Session中多线程的管理：tf.Coordinator和 tf.QueueRunner，这两个类往往一起使用。</li> <li>Coordinator类用来管理在Session中的多个线程，可以用来同时停止多个工作线程并且向那个在等待所有工作线程终止的程序报告异常，该线程捕获到这个异常之后就会终止所有线程。使用tf.train.Coordinator()来创建一个线程管理器（协调器）对象。</li> <li>QueueRunner类用来启动tensor的入队线程，可以用来启动多个工作线程同时将多个tensor（训练数据）推送入文件名称队列中，具体执行函数是 tf.train.start_queue_runners ， 只有调用tf.train.start_queue_runners 之后，才会真正把tensor推入内存序列中，供计算单元调用，否则会由于内存序列为空，数据流图会处于一直等待状态。</li></ul> <h2 id="代码演示：reader-cifar10-1-py"><a href="#代码演示：reader-cifar10-1-py" class="header-anchor">#</a> 代码演示：reader_cifar10-1.py</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># 定义4个图片路径列表</span>
images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'image1.jpg'</span><span class="token punctuation">,</span> <span class="token string">'image2.jpg'</span><span class="token punctuation">,</span> <span class="token string">'image3.jpg'</span><span class="token punctuation">,</span> <span class="token string">'image4.jpg'</span><span class="token punctuation">]</span>
<span class="token comment"># 定义4个Label的列表</span>
labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>

<span class="token comment"># 产生图像和标签对应的tensor</span>
<span class="token punctuation">[</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">]</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>slice_input_producer<span class="token punctuation">(</span><span class="token punctuation">[</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">]</span><span class="token punctuation">,</span>
                              num_epochs<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                              shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment"># 对全局的变量进行初始化</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>local_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 放入线程后，才会产生张量</span>
    tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>start_queue_runners<span class="token punctuation">(</span>sess<span class="token operator">=</span>sess<span class="token punctuation">)</span>  <span class="token comment"># 启动队列填充的线程</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 从文件队列中获取数据， 总共4条 * 2epoch，所以最多取8条</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>输出如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">[</span><span class="token string">b'image1.jpg'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image4.jpg'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image3.jpg'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image2.jpg'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image2.jpg'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image1.jpg'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image4.jpg'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'image3.jpg'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
</code></pre></div><p>代码已经上传到<a href="https://github.com/cwyd0822/cifar10-tensorflow-read-write/blob/master/reader_cifar10-1.py" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="tf-train-string-input-producer-函数"><a href="#tf-train-string-input-producer-函数" class="header-anchor">#</a> tf.train.string_input_producer()函数</h2> <p>这个函数跟tf.train.slice_input_producer()类似，不过是针对文件的生成器，传入文件路径列表，每次吐出一个文件。演示代码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;
读取文件数据
&quot;&quot;&quot;</span>

<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># 我们放了3个文件在相应的位置</span>
filename <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'data/A.csv'</span><span class="token punctuation">,</span> <span class="token string">'data/B.csv'</span><span class="token punctuation">,</span> <span class="token string">'data/C.csv'</span><span class="token punctuation">]</span>

<span class="token comment"># 将文件的路径作为参数传入函数</span>
<span class="token comment"># 输出是文件队列，无法直接获取文件的值</span>
file_queue <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>string_input_producer<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>
                                            shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                            num_epochs<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># 文件读取器</span>
reader <span class="token operator">=</span> tf<span class="token punctuation">.</span>WholeFileReader<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># key：文件名 value:文件值</span>
key<span class="token punctuation">,</span> value <span class="token operator">=</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span>file_queue<span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment"># 对局部变量进行赋值</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>local_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>start_queue_runners<span class="token punctuation">(</span>sess<span class="token operator">=</span>sess<span class="token punctuation">)</span>  <span class="token comment"># 定义文件队列填充的线程</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 文件数量3 * 2epochs</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>输出如下结果：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">[</span><span class="token string">b'data/A.csv'</span><span class="token punctuation">,</span> <span class="token string">b'1.jpg,1\n2.jpg,2\n3.jpg,3\n'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'data/B.csv'</span><span class="token punctuation">,</span> <span class="token string">b'4.jpg,4\n5.jpg,5\n6.jpg,6\n'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'data/C.csv'</span><span class="token punctuation">,</span> <span class="token string">b'7.jpg,7\n8.jpg,8\n9.jpg,9\n'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'data/B.csv'</span><span class="token punctuation">,</span> <span class="token string">b'4.jpg,4\n5.jpg,5\n6.jpg,6\n'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'data/A.csv'</span><span class="token punctuation">,</span> <span class="token string">b'1.jpg,1\n2.jpg,2\n3.jpg,3\n'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">b'data/C.csv'</span><span class="token punctuation">,</span> <span class="token string">b'7.jpg,7\n8.jpg,8\n9.jpg,9\n'</span><span class="token punctuation">]</span>
</code></pre></div><p>这部分代码也放到了我的<a href="https://github.com/cwyd0822/cifar10-tensorflow-read-write/blob/master/reader_cifar10-2.py" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上，大家可以参考。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/article/batch-norm.html" class="prev">batch-norm函数</a></span> <span class="next"><a href="/article/batch-and-shuffle-batch.html">batch函数</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7619c6b3.js" defer></script><script src="/assets/js/2.e197e3e4.js" defer></script><script src="/assets/js/8.88e1533d.js" defer></script>
  </body>
</html>
